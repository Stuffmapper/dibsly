
controllers = angular.module('controllers', )
controllers.controller("MapsCtrl", [ '$scope','$http','MapsService',
  ($scope, $http, MapsService )->
    $scope.mapCenter = '47.6097,-122.3331'


    $scope.$watch( ->
          return MapsService.markers
      (newValue) ->
       $scope.markers = newValue
      )

    updateMarkers = ->
      MapsService.updateMarkers($scope.map)


    $scope.$on('mapInitialized', (evt, map) ->
      updateMarkers()
      google.maps.event.addListener($scope.map, 'dragend', updateMarkers() )
      google.maps.event.addListener($scope.map, 'zoom_changed', updateMarkers() )
      MapsService.map = $scope.map
      navigator.geolocation.getCurrentPosition((position)->
        
        current_location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
        $scope.$apply(->
          $scope.map.panTo(current_location)
          )
        )
      )



])

