
controllers = angular.module('controllers', )
controllers.controller("MapsCtrl", [ '$scope','$http','MapsService',
  ($scope, $http, MapsService )->
    $scope.mapCenter = '47.6097,-122.3331'

    $scope.markers = MapsService.markers
    


    updateMarkers = ->
      neBounds = $scope.map.getBounds().getNorthEast()
      swBounds = $scope.map.getBounds().getSouthWest()
      $http(
        url: '/posts/geolocated'
        params: 
          neLat: neBounds.lat()
          swLat: swBounds.lat() 
          neLng: neBounds.lng()
          swLng: swBounds.lng()
        ).success((data)->
          for marker in data.posts
            if not MapsService.markers[marker.id]
              MapsService.markers[marker.id] = marker 
             )


    $scope.$on('mapInitialized', (evt, map) ->
      self = this

      updateMarkers()
      MapsService.map = map

      google.maps.event.addListener(map, 'dragend', updateMarkers )
      google.maps.event.addListener(map, 'zoom_changed', updateMarkers )
      navigator.geolocation.getCurrentPosition((position)->
        
        current_location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
        $scope.$apply(->
          map.panTo(current_location)
          )
        )
      )



])

