
controllers = angular.module('controllers')




controllers.controller('StuffCtrl', [ '$scope','$window','$modal', 'MapsService','UserService','AlertService', '$http', 
 ($scope, $window, $modal, MapsService, UserService, AlertService, $http ) -> 
     $scope.UserService = UserService;
     $scope.$watchCollection('UserService',->
        $scope.currentUser = UserService.currentUser
     )
     $scope.editing = false
     $scope.$watch( ->
            return MapsService.newMarker
        (newValue) ->
         $scope.newMarker = newValue
         $scope.post.latitude = $scope.newMarker.getPosition().lat()
         $scope.post.longitude = $scope.newMarker.getPosition().lng()

        )
     $scope.mapCenter = '47.6097,-122.3331'

     $scope.markers = MapsService.markers
    


     updateMarkers = ->
      neBounds = $scope.map.getBounds().getNorthEast()
      swBounds = $scope.map.getBounds().getSouthWest()
      $http(
        url: '/posts/geolocated'
        params: 
          neLat: neBounds.lat()
          swLat: swBounds.lat() 
          neLng: neBounds.lng()
          swLng: swBounds.lng()
        ).success((data)->
          for marker in data.posts
            if not MapsService.markers[marker.id]
              MapsService.markers[marker.id] = marker 
             )


     $scope.$on('mapInitialized', (evt, map) ->
      self = this

      updateMarkers()
      MapsService.map = map

      google.maps.event.addListener(map, 'dragend', updateMarkers )
      google.maps.event.addListener(map, 'zoom_changed', updateMarkers )
      navigator.geolocation.getCurrentPosition((position)->
        
        current_location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
        $scope.$apply(->
          map.panTo(current_location)
          )
        )
      )

     $scope.$watch( ->
            return MapsService.markers
        (newValue) ->
         $scope.stuff = newValue

        )
     $scope.post = {}

     $scope.files = []
     $scope.$on("fileSelected",
                (event, args) -> $scope.$apply( ->  
                    $scope.files.push(args.file)
                    console.log($scope.files)
                ))

     $scope.stuff =  MapsService.markers
     $scope.mystuff = {}
     $scope.loading = false

     $scope.getMyStuff = ->
        $http(
            url: '/my-stuff'
          ).success((data)->
            for stuff in data.posts
                if not $scope.mystuff[stuff.id]
                    $scope.mystuff[stuff.id] = stuff
                    $scope.mystuff =  data.posts  )



     $scope.submitPost = ->
        $scope.loading = true
        UserService.check(->)
        if UserService.currentUser
            formdata = new FormData();
            formdata.append('latitude', $scope.post.latitude)
            formdata.append('longitude', $scope.post.longitude)
            formdata.append('category', $scope.post.category)
            formdata.append('description', $scope.post.description)
            formdata.append('image', $scope.files[0]);
            $http.post( "/posts", formdata, {
                headers: {'Content-Type': undefined}
                transformRequest: angular.identity
                }).success (data, status, headers, config) -> 
                    console.log('it worked')
                    AlertService.add('success', "You've Posted Your Stuff")
                    $scope.files = []
                    $scope.loading = false
                    updateMarkers()
                .error (data) ->
                    for key, value of data
                        AlertService.add('danger', key + ' ' + value )
                    $scope.loading = false
        else
            AlertService.add('danger', 'Please sign in to continue' )
            $modal.open
                templateUrl:'signIn.html',
                controller:'SignUpCtrl'



     $scope.startMapper = ->
         center = MapsService.map.getCenter()
         if $scope.postMarker 
            $scope.postMarker.setMap(null)

         $scope.postMarker = new google.maps.Marker(position: center,draggable:true, map:MapsService.map,title:'Your Stuff',icon: '<%= asset_path('icon.png')%>')
         updatePost = ->
            $scope.post.latitude = $scope.postMarker.getPosition().lat()
            $scope.post.longitude = $scope.postMarker.getPosition().lng()
         google.maps.event.addListener($scope.postMarker, 'dragend', updatePost )
         google.maps.event.addListener($scope.postMarker, 'idle', updatePost )
         $scope.postMarker.setMap(MapsService.map)
         MapsService.map.setZoom(16)
         $scope.post.latitude = $scope.postMarker.getPosition().lat()
         $scope.post.longitude = $scope.postMarker.getPosition().lng()


                                    



])
      

