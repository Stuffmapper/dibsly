(function() {
  var controllers;

  controllers = angular.module('controllers');

  controllers.controller('StuffCtrl', [
    '$scope', '$timeout', '$location', '$routeParams', '$window', '$modal', '$resource', 'ImageService',
    'LocationService','MapsService', 'MarkerService', 'UserService', 'AlertService',
    '$rootScope', '$http', function($scope, $timeout, $location, $routeParams, $window, $modal, $resource,
      ImageService, LocationService,MapsService, MarkerService, UserService, AlertService, $rootScope, $http) {
      var init, updateMarkers, updatePostMarker;
      $scope.UserService = UserService;
      $scope.$watchCollection('UserService', function() {
        return $scope.currentUser = UserService.currentUser;
      });
      setMenu = function() {
        console.log($routeParams);
        if($routeParams.menuState){
          $scope.showtab($routeParams.menuState);
          console.log($routeParams);
        } else if($location.url() == '/' ) { updateMarkers($scope.map) }
      };

      init = function() {
        $scope.backup = {};
        UserService.check();
        setMenu();
      };
      $scope.attached = false;
      $scope.categories = MarkerService.categories;

      $scope.giveflow = {
        1: [true, ''],
        2: [false, '']
      };
      $scope.loading = false;
      $scope.mapCenter = '47.6097,-122.3331';
      $scope.mapHeight = 'map-0';
      $scope.menuHeight = 'menu-0';
      $scope.post = {};
      $scope.tabs = {
        getStuff: [ true, '' ],
        giveStuff:[ false,  '' ],
        myStuff: [ false, '' ],
        details: [ false,  ''],
        editing: [ false, '']
      };
      $scope.toggle = false;


      $scope.cancelGive = function() {
        $scope.loading = false;
        $scope.giveNext(1);
        $scope.attached = false;
        $scope.file = {};
        delete $scope.file;
        return $scope.post = {};
      };

      $scope.centerMap = function(){
        var center;

        return LocationService.get().then(
          function(position){
            console.log(' this is line 66')

            center = MapsService.newLatLng(position.coords.latitude,
              position.coords.longitude);
          },
          function(error){
            //console.log('this is 71', error);
            center = MapsService.getCenter($scope.map);
          }
         )
         .then( function(){ MapsService.panTo($scope.map, center);})
      }

      $scope.edit = function(id) {
        $scope.showtab('editing');
        $scope.file = null;
        $scope.editItem = MarkerService.markers[id];
        return $scope.current_image = $scope.editItem.image_url;
      };
      $scope.giveNext = function(id) {
        return angular.forEach($scope.giveflow, function(value, key) {
          var stat;
          stat = String(id);
          $scope.mapHeight = 'map-1-' + stat
          $scope.menuHeight = 'menu-1-' + stat
          if (key === stat) {
            $location.path('/menu/giveStuff/' + stat, false);
            return $scope.giveflow[key][0] = true;
          } else {
            return $scope.giveflow[key][0] = false;
          }
        });
      };
      $scope.getDetails = function(id, origin) {
        $location.path('/post/' + id, false);
        if (MarkerService.markers[id] && origin !== 'marker') {
          MapsService.triggerMarkerEvent(MarkerService.markers[id].marker, 'click' );
          return $scope.stuff = MarkerService.markers[id];
        } else {
          return MarkerService.updateMarker(id, origin, function() {
            return $scope.stuff = MarkerService.markers[id];
          });
        }
      };
      $scope.myStuff = function() {
        $location.path('/menu/myStuff', false)
        if ($scope.postMarker) {
          $scope.postMarker.setMap(null);
        }
        if ($scope.editMarker) {
          $scope.editMarker.setMap(null);
        }
        $scope.toggle = false;
        return UserService.check()
        .then(
          function (data){
            return $http.get('/api/my-stuff')
              .success(function(data) {
                angular.forEach(data.posts, function(marker) {
                  marker.currentUser = UserService.currentUser;
                  MarkerService.setMarker(marker);
                });
              })
              .error( function(err){ console.log(' Could not get my-stuff')})
          },
          function(err){
            console.log('User not logged in');
          }
        )
        .then( function(){
          if (UserService.currentUser) {
              return $http.get('/api/my-dibs').success(function(data) {
                var i, len, marker, ref, results;
                ref = data.posts;
                results = [];
                for (i = 0, len = ref.length; i < len; i++) {
                  marker = ref[i];
                  marker.currentUser = UserService.currentUser;
                  marker.dibber = UserService.currentUser;
                  MarkerService.setMarker(marker);
                }
                return results;
              });
            }

        });
      }
      $scope.images = function(){
        return ImageService.images[$routeParams.menuState]
      }
      $scope.getStuff = function() {
        $location.path('/menu/getStuff', false)
        $scope.toggle = false;
        $scope.menuHeight = 'get-stuff-view';
        updateMarkers($scope.map)
        MapsService.addMapListener($scope.map, 'dragend', function() {
          return updateMarkers($scope.map);
        });
        MapsService.addMapListener($scope.map, 'zoom_changed', function() {
          return updateMarkers($scope.map);
        });
      };
      $scope.markGone = function(id) {
        var post;
        post = {
          status: 'gone'
        };
        return $http.post("/api/posts/" + id + "/update", post).success(function() {
          return AlertService.add('success', "Marked as gone");
        }).error(function() {
          return AlertService.add('warning', "Something went wrong");
        });
      };
      $scope.menuToggle = function() {
        return $scope.toggle = !$scope.toggle;
      };
      $scope.publish = function(status) {
        if (UserService.currentUser) {
          return $http.post("/api/posts/" + $scope.editItem.id + "/update", {
            published: status
          }).success( console.log('success') )
          .error(console.log);
        }
      };
      $scope.removeDibber = function(id, description, postID) {
        var report;
        report = {
          description: description
        };
        return $http.post('/api/dibs/' + id + '/removedib', {
          report: report
        }).success($scope.mystuff.posts[postID]['dibbable'] = true);
      };
      $scope.giveStuff = function() {
        $scope.menuHeight = 'menu-1-1';
        $scope.mapHeight = 'map-1-1';
        var state = $routeParams.next ? $routeParams.next : 1
        $scope.giveNext(state);
        var markerSet = MarkerService.markers['giveStuff'];
        var marker = markerSet ? markerSet : {id: 'giveStuff'};
        MarkerService.clearMarkers('giveStuff', $scope.map );
        if(!markerSet){
          var center = MapsService.getCenter($scope.map);
          LocationService.get()
          .then(
            function(position){
              center = MapsService.newLatLng(position.coords.latitude, position.coords.longitude);
            },
            function(err){ console.log('geolocation not supported') })
          .then( function() {
            angular.extend( marker, { latitude: center.lat(), longitude: center.lng() });
            MarkerService.setMarker(marker);
          })
        }
      };

      $scope.submitPost = function() {
        $scope.loading = true;
        return UserService.check()
          .then(
            function(){
              var formdata, token;
              if (UserService.currentUser) {
                formdata = new FormData();
                angular.forEach(MarkerService.editProperties, function(value){
                  if($scope.post[value]){
                    formdata.append(value, $scope.post[value]);
                  }
                });
                formdata.append('image', $scope.file);
                $http.post("/api/posts", formdata, {
                  headers: {
                    'Content-Type': void 0,
                  },
                  transformRequest: angular.identity
                }).success(function(data, status, headers, config) {
                  var post;
                  AlertService.add('success', "You've Posted Your Stuff");
                  $scope.cancelGive();
                  updateMarkers();
                  $scope.giveNext(1);
                  post = data.post;
                  post.image_url = $scope.current_image;
                  post.originalImage = $scope.current_image;
                  MarkerService.setMarker(post);
                  $scope.stuff = MarkerService.markers[post.id];
                  $scope.menuHeight = 'get-stuff-view';
                  $location.path('/post/' + post.id, false);
                  return $scope.showtab('details');
                }).error(function(data) {
                  var key, value;
                  for (key in data) {
                    value = data[key];
                    AlertService.add('danger', key + ' ' + value);
                  }
                  return $scope.loading = false;
                });
              }
            },
            function(err){
              console.log(err);
              AlertService.add('danger', 'Please sign in to continue');
              $scope.loading = false;
              return $modal.open({
                templateUrl: 'signIn.html',
                controller: 'SignUpCtrl'
              });
            }
          )
      };
      $scope.updateStuff = function() {
        return UserService.check()
        .then( function() {
          var formdata;
          if (UserService.currentUser) {
            angular.forEach(MarkerService.editProperties, function(value){
              if($scope.editItem[value]){
                formdata.append(value, $scope.editItem[value]);
              }
            });
            if ($scope.file) {
              formdata.append('image', $scope.file);
              $scope.loading = true;
            }
          return $http.post("/api/posts/" + $scope.editItem.id + "/update", formdata, {
            headers: {
              'Content-Type': void 0
            },
            transformRequest: angular.identity })
            .success(function(data, status, headers, config) {
              if ($scope.editMarker) {
                $scope.editItem.marker.setPosition($scope.editMarker.getPosition());
                $scope.editMarker.setMap(null);
              }
              AlertService.add('success', "Your post has been updated");
              $scope.attached = false;
              delete $scope.file;
              $scope.loading = false;
              return $scope.current_image = '';})
            .error(function(data) {
              var key, results, value;
              results = [];
              for (key in data) {
                value = data[key];
                results.push(AlertService.add('danger', key + ' ' + value));
              }
            });
          }
        },
        function(){
          AlertService.add('danger', 'Please sign in to continue');
          $modal.open({
            templateUrl: 'signIn.html',
            controller: 'SignUpCtrl'
           });
         }
        );
      };
      $rootScope.$on("detailsWanted", function(event, args) {
        var dets, id;
        id = args.markerId;
        MarkerService.updateWindow(id);
        angular.forEach(MarkerService.markers, function(value, key) {
          if (key !== String(id)) {
            if (value.infowindow) {
              return value.infowindow.close($scope.map, value.marker);
            }
          } else {
            return value.infowindow.open($scope.map, value.marker);
          }
        });
        dets = function() {
          return $scope.getDetails(id, 'marker');
        };
        return $timeout(dets, 0);
      });

      $scope.$on("fileSelected", function(event, args) {
        $scope.giveNext(2);
        ImageService.createGroup(args)
      });

      $scope.$on('mapInitialized', function(evt, map) {
        var blank, self;
        if ($routeParams.postId) {
          $scope.getDetails($routeParams.postId, 'initial');
        }
        self = this;
        blank = function() {};
        updatePostMarker(blank, 25000, $scope.map);
        $scope.centerMap()
        init();
      });
      $scope.showtab = function(tab) {
        return angular.forEach($scope.tabs, function(value, key) {
          if (key === tab) {
            $scope.tabs[key][0] = true;

            if(typeof $scope[key] == 'function'){
              $scope[key]();
            };
          } else {
            return $scope.tabs[key][0] = false;
          }
        });
      };
      updateMarkers = function(map) {
        var neBounds, swBounds;
        if (map) {
          neBounds = map.getBounds().getNorthEast();
          swBounds = map.getBounds().getSouthWest();
          return $http({
            url: '/api/posts/geolocated',
            params: {
              neLat: neBounds.lat(),
              swLat: swBounds.lat(),
              neLng: neBounds.lng(),
              swLng: swBounds.lng()
            }
          }).success(function(data) {
            var i, len, marker, ref, results;
            ref = data.posts;
            for (i = 0, len = ref.length; i < len; i++) {
              marker = ref[i];
              if (marker.originalImage === 'missing') {
                marker.originalImage = '<%= asset_path('processing.png')%>';
                marker.image_url = '<%= asset_path('processing.png')%>';
              }
              marker.currentUser = UserService.currentUser;
              MarkerService.setMap(map);
              MarkerService.setMarker(marker);
            }
          });
        }
      };
      updatePostMarker = function(callback, timeout, map) {
        var centerError, centerSuccess, geoOptions, resetMarker, self, updateMarker;
        if (map) {
          self = this;
          self.callback = callback;
          resetMarker = function() {
            if ($scope.postMarker) {
              return $scope.postMarker.setMap(null);
            }
          };
          updateMarker = function(center) {
            var updatePost;
            resetMarker();
            $scope.postMarker = MapsService.newMapMarker({
              position: center,
              draggable: true,
              map: $scope.map,
              title: 'Your Stuff',
              icon: MarkerService.icons.new
            });
            updatePost = function() {
              $scope.post.latitude = $scope.postMarker.getPosition().lat();
              return $scope.post.longitude = $scope.postMarker.getPosition().lng();
            };
            MapsService.addMarkerListener($scope.postMarker, 'dragend', updatePost);
            MapsService.addMarkerListener($scope.postMarker, 'idle', updatePost);
            map.setZoom(12);
            map.panTo(center);
            $scope.post.latitude = $scope.postMarker.getPosition().lat();
            $scope.post.longitude = $scope.postMarker.getPosition().lng();
            return self.callback();
          };
        }
      };;
    }
  ]);

}).call(this);
