(function() {
  var factories;

  factories = angular.module('factories');

  factories.factory('MarkerService', [
    '$http','LocalService','MapsService', '$resource', '$rootScope',
     function($http,LocalService,MapsService,$resource, $rootScope) {
      var Marker;
      Marker = $resource('/api/posts/:id', {
        id: '@id'
      });
      Marker.prototype.showEdit = function() {
        var self = this
        return (self.creator && self.currentUser &&
          self.creator === self.currentUser)};
      Marker.prototype.showDib = function() {
        var self = this
        return ( !self.showEdit() && !self.isCurrentDibber && self.dibbable )};
      Marker.prototype.showUnDib = function() {
        var self = this
        return self.isCurrentDibber ? true : false };
      Marker.prototype.editProperties = function(){
        return [  'category',
                  'description',
                  'latitude',
                  'longitude',
                  'published',
                  'title'
                ];
      };
      return {
        editProperties: [
          'id',
          'category',
          'description',
          'image_url',
          'latitude',
          'longitude',
          'on_the_curb',
          'published',
          'title'
        ],
        markers: {},
        map: null,
        icons: {
            standard:'<%= asset_path('blue-circle.png')%>',
            dibber: '<%= asset_path('my-want.png')%>',
            creator:'<%= asset_path('my-marker.png')%>',
            moving: '<%= asset_path('green-pin.png')%>',
            new: '<%= asset_path('pin.svg')%>'
          },
        categories:[
          'Arts & Crafts',
          'Books, Games, Media',
          'Building & Garden Materials',
          'Clothing & Accessories',
          'Electronics',
          'Furniture & Household',
          'General',
          'Kids & Babies',
          'Recreation'
        ],

        clearMarkers: function( exception, map ){
          var self = this;
          angular.forEach(self.markers, function(value, key) {
             if (key !== exception && value.marker ){
              MapsService.setMapMarker(value.marker, null)
             } else { value.marker.setMap(map) }
          });
        },
        contains: function(object, attributes){
          var contains = false;
          angular.forEach(attributes, function(value, attr){
            if(object[attr] && object[attr] === value){
              return contains = true;
            }
          });
          return contains;
        },
        isEmpty: function(obj){
          // null and undefined are "empty"
          if (obj == null) return true;
          if (obj.length > 0)    return false;
          if (obj.length === 0)  return true;
          for (var key in obj) {
              if (hasOwnProperty.call(obj, key)) return false;
          }
          return true;
        },
        saveLocal: function(marker){
          var self = this;
          var cached = JSON.parse( LocalService.get('markers')) || {};
          var data = {};
          angular.forEach(self.editProperties, function(value){
            if(marker[value]){
              data[value] = marker[value]
            }
          });
          cached[marker.id] = data;
          LocalService.set('markers', JSON.stringify(cached))
        },
        delete: function(marker){
          self = this;
          var cached = JSON.parse( LocalService.get('markers')) || {};
          delete cached[marker.id];
          delete self.markers[marker.id];
          LocalService.set('markers', JSON.stringify(cached) )
        },
        setGoogleMarker: function(marker){
          if(!marker.marker) {
            var self = this;
            var latLng = MapsService.newLatLng(marker.latitude, marker.longitude);
            var options = {
              zoom: 4,
              center: latLng
            };
            marker.marker = MapsService.newMapMarker({
              icon: self.icons.standard,
              position: latLng,
              map: self.map,
              title: marker.description
            });
          }
          return MapsService.addMarkerListener( marker.marker, 'click', function() {
            $rootScope.$broadcast('detailsWanted', {
              markerId: marker.id
            });
          });
          return marker;
        },

        updateMarker: function(id, origin, callback) {
          var self;
          self = this;
          return Marker.get({
            id: id
          }).$promise.then(function(post) {
            if (post.post.originalImage === 'missing') {
              if (self.markers[id]) {
                post.post.originalImage = $scope.markers[id].originalImage;
                post.post.image_url = self.markers[id].image_url;
              } else {
                post.post.originalImage = '<%= asset_path('processing.png')%>';
                post.post.image_url = '<%= asset_path('processing.png')%>';
              }
            }
            self.setMarker(post.post)
            if (origin !== 'marker') {
              MapsService.triggerMarkerEvent(self.markers[id].marker, 'click');
            }
            return callback();
          });
        },
        updateWindow: function(id) {
          var infowindow, innerContent, marker, self;
          self = this;
          marker = self.markers[id];
          innerContent = "<div > <div id='siteNotice' class='stuff-map-image'></div> <img src=" +
           marker.image_url + " width='200px' ></img> <div id='bodyContent'> <p>" +
           marker.description + "</p> </div> </div> </div>";
          if (!marker.description) {
            marker.description = "";
          }
          if (!marker.infowindow) {
            infowindow = MapsService.newInfoWindow({
              content: innerContent
            });
            return marker.infowindow = infowindow;
          } else {
            return MapsService.setInfoContent(marker, innerContent);
          }
        },

        setMap: function(map) {
          var self;
          self = this;
          self.map = map;
        },

        setMarker: function(marker){
          var self;
          self = this;
          marker.updated_at = new Date(marker.updated_at);
          marker.locallyUpdated = Date.now();
          marker.mapped = true; //TODO remove this
          if(!self.markers[marker.id]){
            self.markers[marker.id] = new Marker(marker);
          } else { angular.extend(self.markers[marker.id], marker ) }
          self.saveLocal( self.markers[marker.id] )
          self.setGoogleMarker(self.markers[marker.id]);
        },

        where: function(has, doesnot){
          var self = this;
          var results = [];
          angular.forEach(self.markers,
            function(value ){
              if(self.contains(value,has) && !self.contains(value, doesnot)){
                results.push(value)
              } else if ( !self.contains(value, doesnot) && self.isEmpty(has) ) {  //TOFIX
                results.push(value);
              }
            }
          );
          results.sort(function (a, b) {
            return (a['updated_at'] < b['updated_at'] ? 1 : -1);

          });
          return results;
        }
      };
    }
  ]);

}).call(this);
